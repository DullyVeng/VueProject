# 小地图探索系统 迭代计划

**创建时间**：2026-01-15  
**状态**：已完成 ✅

---

## 迭代目标

实现类《勇者斗恶龙》风格的小地图探索系统，在现有"大地图"基础上增加可进入的"小地图"，玩家可以在地图上自由移动、探索，遭遇显性和隐性怪物进行战斗。

**预期成果**：
- 点击"探索"按钮后进入小地图界面
- 玩家角色可在网格地图上移动
- 实现显性怪物（可见，主动接触触发战斗）
- 实现隐性怪物（每移动一格概率性遭遇）
- 地图边缘退出机制
- 右下角显示隐性怪物遭遇概率

---

## 迭代范围

### 包含功能
- 小地图视图组件 (`ExplorationMapView.vue`)
- 网格地图渲染（Canvas/CSS Grid）
- 玩家角色在地图上的移动（键盘WASD/方向键 + 点击移动）
- 显性怪物的显示和碰撞检测
- 隐性怪物的随机遭遇机制
- 地图边缘退出功能
- 小地图数据配置文件

### 不包含功能（明确边界）
- NPC交互系统（后续迭代）
- 宝箱/道具拾取（后续迭代）
- 地图内采集资源（后续迭代）
- 地图内存档点（后续迭代）
- 小地图背景音乐（后续迭代）

---

## 阶段划分

### 阶段一：基础框架搭建
**目标**：创建小地图视图和基础渲染

**任务**：
- [x] 创建 `ExplorationMapView.vue` 组件
- [x] 实现网格地图渲染
- [x] 创建小地图配置数据结构 `explorationMaps.js`
- [x] 添加路由 `/exploration/:mapId`

**预计时间**：1天

---

### 阶段二：玩家移动系统
**目标**：实现玩家在地图上的移动

**任务**：
- [x] 玩家角色渲染
- [x] 键盘控制移动（WASD/方向键）
- [x] 网格碰撞检测（墙壁、障碍物）
- [x] 地图边缘退出检测

**预计时间**：1天

---

### 阶段三：怪物系统
**目标**：实现显性和隐性怪物

**任务**：
- [x] 显性怪物渲染和移动AI
- [x] 玩家与显性怪物碰撞触发战斗
- [x] 隐性怪物遭遇概率计算
- [x] 遭遇率UI显示（右下角）
- [x] 战斗触发后跳转到战斗界面

**预计时间**：1天

---

## 技术栈

- **前端**：Vue 3, Pinia, Canvas 2D（最终采用）
- **后端**：Supabase（后续存储探索进度）
- **渲染**：Canvas 2D（性能更好）

---

## 依赖关系

- 依赖现有战斗系统 `CombatView.vue` 和 `useCombatStore`
- 依赖现有地图数据 `maps.js`
- 依赖现有怪物数据 `monsters.js`

---

## 风险点

| 风险 | 影响 | 应对方案 | 状态 |
|------|------|----------|------|
| 地图渲染性能问题 | 中 | 使用Canvas 2D，摄像机视口渲染 | ✅ 已解决 |
| 移动手感不佳 | 中 | 摄像机跟随，玩家居中 | ✅ 已解决 |
| 隐性遭遇太频繁/太少 | 低 | 提供可配置的遭遇率参数 | ✅ 已实现 |

---

## 里程碑

- [x] 里程碑1 - 完成基础地图渲染和玩家显示
- [x] 里程碑2 - 完成玩家移动和边界检测
- [x] 里程碑3 - 完成怪物系统和战斗触发

---

## 额外完成功能

### 位置持久化
- [x] localStorage 保存玩家位置
- [x] 刷新页面恢复位置
- [x] 智能初始化逻辑

### 摄像机系统
- [x] 玩家始终在屏幕中心
- [x] Canvas transform 实现
- [x] 边界智能限制

### 地图扩展
- [x] 地图尺寸扩大到 200x150
- [x] 地形平铺算法

---

## 后续优化计划

### 程序化地图生成系统

已规划但未实施的优化项目，详见：
- [地图生成器实现计划](./map-generator-plan.md)
- [地图生成器任务清单](./map-generator-task.md)

**核心改进**：
- ✨ 随机地图生成（挖掘者算法）
- 🚀 视口裁剪渲染优化（60+ FPS）
- 💾 Int8Array数据结构（节省75%内存）
- 🔗 100%连通性保证
- 📊 40%+通路占比

**预计工作量**：5.5小时

---

*最后更新：2026-01-15*

