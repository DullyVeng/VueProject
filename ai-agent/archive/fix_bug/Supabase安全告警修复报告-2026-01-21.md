# Supabase å®‰å…¨å‘Šè­¦ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2026-01-21  
**æ‰§è¡Œäºº**: AI Agent  
**é¡¹ç›®**: JavaProject (ä¿®ä»™RPGæ¸¸æˆ)

---

## ğŸ“‹ å‘Šè­¦æ¦‚è¿°

Supabase æ£€æµ‹åˆ° 3 ä¸ªå®‰å…¨é—®é¢˜,æ¶‰åŠæ•°æ®æ³„éœ²å’Œæƒé™æå‡é£é™©:

| # | å¯¹è±¡ | é—®é¢˜ç±»å‹ | é£é™©ç­‰çº§ |
|---|------|---------|----------|
| 1 | `public.character_derived_stats` | è§†å›¾ä½¿ç”¨ SECURITY DEFINER | âš ï¸ ä¸­ç­‰ |
| 2 | `public.boss_defeats` | è¡¨æœªå¯ç”¨ RLS | ğŸš¨ é«˜ |
| 3 | `public.player_quests` | è¡¨æœªå¯ç”¨ RLS | ğŸš¨ é«˜ |

---

## ğŸ” é—®é¢˜è¯¦ç»†åˆ†æ

### å‘Šè­¦ 1: character_derived_stats è§†å›¾å®‰å…¨é—®é¢˜

**åŸå§‹é…ç½®**:
- è§†å›¾å±æ€§: `SECURITY DEFINER`
- å½±å“: æ‰€æœ‰æŸ¥è¯¢ä½¿ç”¨è§†å›¾åˆ›å»ºè€…(é€šå¸¸æ˜¯è¶…çº§ç®¡ç†å‘˜)çš„æƒé™æ‰§è¡Œ

**æ½œåœ¨é£é™©**:
- å¯èƒ½ç»•è¿‡åº•å±‚è¡¨çš„ RLS ç­–ç•¥
- å¦‚æœè§†å›¾æœ‰æ¼æ´,å¯èƒ½æ³„éœ²ä¸åº”è¢«è®¿é—®çš„æ•°æ®

**å®é™…åœºæ™¯**:
- è¯¥è§†å›¾ä» `characters` è¡¨æ´¾ç”Ÿè®¡ç®—å±æ€§(æˆ˜æ–—åŠ›ã€ä¸¹ç”°å®¹é‡ç­‰)
- åº•å±‚ `characters` è¡¨å·²æœ‰ RLS ä¿æŠ¤
- å› æ­¤å®é™…é£é™©è¾ƒä½,ä½†ä»æœ‰ä¼˜åŒ–ç©ºé—´

---

### å‘Šè­¦ 2: boss_defeats è¡¨ç¼ºå°‘ RLS ä¿æŠ¤

**è¡¨ç»“æ„**:
```sql
CREATE TABLE boss_defeats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),  -- ç”¨æˆ·ID
  map_id TEXT,                              -- åœ°å›¾ID
  defeated_at TIMESTAMPTZ DEFAULT NOW()     -- å‡»è´¥æ—¶é—´
);
```

**æœªä¿®å¤å‰çš„é£é™©**:
- âŒ ä»»ä½•ç©å®¶å¯ä»¥æŸ¥çœ‹æ‰€æœ‰äººçš„ Boss å‡»è´¥è®°å½•
- âŒ ç©å®¶å¯ä»¥ä¼ªé€ è‡ªå·±çš„å‡»è´¥è®°å½•
- âŒ ç©å®¶å¯ä»¥åˆ é™¤æˆ–ä¿®æ”¹ä»–äººçš„è®°å½•
- âŒ 24å°æ—¶åˆ·æ–°æœºåˆ¶å¯è¢«ç»•è¿‡

**æ¸¸æˆå…¬å¹³æ€§å½±å“**: ğŸš¨ **ä¸¥é‡**

---

### å‘Šè­¦ 3: player_quests è¡¨ç¼ºå°‘ RLS ä¿æŠ¤

**è¡¨ç»“æ„**:
```sql
CREATE TABLE player_quests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  character_id UUID REFERENCES characters(id),  -- è§’è‰²ID
  quest_id VARCHAR,                             -- ä»»åŠ¡ID
  status VARCHAR DEFAULT 'active',              -- ä»»åŠ¡çŠ¶æ€
  objectives JSONB DEFAULT '[]',                -- ä»»åŠ¡ç›®æ ‡
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
);
```

**æœªä¿®å¤å‰çš„é£é™©**:
- âŒ ä»»ä½•ç©å®¶å¯ä»¥æŸ¥çœ‹æ‰€æœ‰äººçš„ä»»åŠ¡è¿›åº¦
- âŒ ç©å®¶å¯ä»¥ç›´æ¥ä¿®æ”¹ä»»åŠ¡çŠ¶æ€ä¸º"å·²å®Œæˆ"
- âŒ ç©å®¶å¯ä»¥è·³è¿‡æ¸¸æˆé€»è¾‘ç›´æ¥é¢†å–å¥–åŠ±
- âŒ ä»»åŠ¡ç³»ç»Ÿå®Œå…¨å¤±æ•ˆ

**æ¸¸æˆå…¬å¹³æ€§å½±å“**: ğŸš¨ **ä¸¥é‡**

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: ä¼˜åŒ– character_derived_stats è§†å›¾å®‰å…¨æ€§

**æ‰§è¡Œçš„è¿ç§»**: `optimize_character_derived_stats_view_security`

**ä¿®å¤å†…å®¹**:
```sql
-- åˆ é™¤æ—§è§†å›¾å¹¶é‡æ–°åˆ›å»º,ä½¿ç”¨ SECURITY INVOKER
DROP VIEW IF EXISTS public.character_derived_stats;

CREATE VIEW public.character_derived_stats
WITH (security_invoker = true)  -- å…³é”®æ”¹åŠ¨!
AS
SELECT 
  id, user_id, name, level,
  spirit_power, divine_sense, body_constitution,
  comprehension, fortune,
  -- è®¡ç®—å±æ€§
  25 + spirit_power AS dantian_capacity,
  (10 + FLOOR(spirit_power / 5))::INTEGER AS calculated_max_action_points,
  -- ... å…¶ä»–æ´¾ç”Ÿå±æ€§
FROM public.characters;
```

**æ”¹è¿›ç‚¹**:
- âœ… è§†å›¾ç°åœ¨ä½¿ç”¨æŸ¥è¯¢ç”¨æˆ·çš„æƒé™,è€Œä¸æ˜¯åˆ›å»ºè€…æƒé™
- âœ… è‡ªåŠ¨ç»§æ‰¿åº•å±‚ `characters` è¡¨çš„ RLS ç­–ç•¥
- âœ… æ¶ˆé™¤æ½œåœ¨çš„æƒé™æå‡é£é™©
- âœ… æ›´ç¬¦åˆæœ€å°æƒé™åŸåˆ™

---

### ä¿®å¤ 2: ä¸º boss_defeats è¡¨å¯ç”¨ RLS å¹¶åˆ›å»ºç­–ç•¥

**æ‰§è¡Œçš„è¿ç§»**: `enable_rls_for_boss_defeats_and_player_quests`

**ä¿®å¤å†…å®¹**:
```sql
-- 1. å¯ç”¨ RLS
ALTER TABLE public.boss_defeats ENABLE ROW LEVEL SECURITY;

-- 2. åˆ›å»ºæŸ¥è¯¢ç­–ç•¥
CREATE POLICY "ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„BOSSå‡»è´¥è®°å½•"
ON public.boss_defeats
FOR SELECT
USING (auth.uid() = user_id);

-- 3. åˆ›å»ºæ’å…¥ç­–ç•¥
CREATE POLICY "ç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„BOSSå‡»è´¥è®°å½•"
ON public.boss_defeats
FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- 4. åˆ›å»ºåˆ é™¤ç­–ç•¥
CREATE POLICY "ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„BOSSå‡»è´¥è®°å½•"
ON public.boss_defeats
FOR DELETE
USING (auth.uid() = user_id);
```

**ç­–ç•¥æ•ˆæœ**:
- âœ… ç©å®¶åªèƒ½æŸ¥çœ‹è‡ªå·±çš„å‡»è´¥è®°å½•
- âœ… ç©å®¶åªèƒ½ä¸ºè‡ªå·±åˆ›å»ºè®°å½•
- âœ… ç©å®¶åªèƒ½åˆ é™¤è‡ªå·±çš„è®°å½•(ç”¨äºæµ‹è¯•æˆ–ç®¡ç†åŠŸèƒ½)
- âœ… å®Œå…¨é˜»æ­¢æ•°æ®æ³„éœ²å’Œä½œå¼Šè¡Œä¸º

---

### ä¿®å¤ 3: ä¸º player_quests è¡¨å¯ç”¨ RLS å¹¶åˆ›å»ºç­–ç•¥

**ä¿®å¤å†…å®¹**:
```sql
-- 1. å¯ç”¨ RLS
ALTER TABLE public.player_quests ENABLE ROW LEVEL SECURITY;

-- 2. åˆ›å»ºæŸ¥è¯¢ç­–ç•¥
CREATE POLICY "ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±è§’è‰²çš„ä»»åŠ¡"
ON public.player_quests
FOR SELECT
USING (
  character_id IN (
    SELECT id FROM public.characters WHERE user_id = auth.uid()
  )
);

-- 3. åˆ›å»ºæ’å…¥ç­–ç•¥
CREATE POLICY "ç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±è§’è‰²çš„ä»»åŠ¡"
ON public.player_quests
FOR INSERT
WITH CHECK (
  character_id IN (
    SELECT id FROM public.characters WHERE user_id = auth.uid()
  )
);

-- 4. åˆ›å»ºæ›´æ–°ç­–ç•¥
CREATE POLICY "ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±è§’è‰²çš„ä»»åŠ¡"
ON public.player_quests
FOR UPDATE
USING (
  character_id IN (
    SELECT id FROM public.characters WHERE user_id = auth.uid()
  )
);

-- 5. åˆ›å»ºåˆ é™¤ç­–ç•¥
CREATE POLICY "ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±è§’è‰²çš„ä»»åŠ¡"
ON public.player_quests
FOR DELETE
USING (
  character_id IN (
    SELECT id FROM public.characters WHERE user_id = auth.uid()
  )
);
```

**ç­–ç•¥é€»è¾‘**:
- é€šè¿‡ `character_id` å…³è”åˆ° `characters` è¡¨
- æ£€æŸ¥è§’è‰²æ˜¯å¦å±äºå½“å‰ç™»å½•ç”¨æˆ·(`auth.uid()`)
- æ”¯æŒä¸€ä¸ªç”¨æˆ·æ‹¥æœ‰å¤šä¸ªè§’è‰²çš„åœºæ™¯

**ç­–ç•¥æ•ˆæœ**:
- âœ… ç©å®¶åªèƒ½è®¿é—®è‡ªå·±è§’è‰²çš„ä»»åŠ¡
- âœ… å®Œå…¨é˜»æ­¢è·¨ç”¨æˆ·æ•°æ®è®¿é—®
- âœ… é˜²æ­¢ä»»åŠ¡è¿›åº¦ä½œå¼Š
- âœ… ä¿æŠ¤æ¸¸æˆå…¬å¹³æ€§

---

## ğŸ“Š ä¿®å¤éªŒè¯ç»“æœ

### RLS å¯ç”¨çŠ¶æ€

| è¡¨å | RLS çŠ¶æ€ | ç­–ç•¥æ•°é‡ | çŠ¶æ€ |
|------|---------|---------|------|
| `boss_defeats` | âœ… å·²å¯ç”¨ | 3 ä¸ªç­–ç•¥ | âœ… å·²ä¿®å¤ |
| `player_quests` | âœ… å·²å¯ç”¨ | 4 ä¸ªç­–ç•¥ | âœ… å·²ä¿®å¤ |
| `characters` | âœ… å·²å¯ç”¨ | 3 ä¸ªç­–ç•¥ | âœ… åŸæœ¬æ­£å¸¸ |

### å·²åˆ›å»ºçš„ç­–ç•¥æ¸…å•

**boss_defeats è¡¨** (3ä¸ªç­–ç•¥):
1. âœ… `ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„BOSSå‡»è´¥è®°å½•` (SELECT)
2. âœ… `ç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„BOSSå‡»è´¥è®°å½•` (INSERT)
3. âœ… `ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„BOSSå‡»è´¥è®°å½•` (DELETE)

**player_quests è¡¨** (4ä¸ªç­–ç•¥):
1. âœ… `ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±è§’è‰²çš„ä»»åŠ¡` (SELECT)
2. âœ… `ç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±è§’è‰²çš„ä»»åŠ¡` (INSERT)
3. âœ… `ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±è§’è‰²çš„ä»»åŠ¡` (UPDATE)
4. âœ… `ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±è§’è‰²çš„ä»»åŠ¡` (DELETE)

### è§†å›¾å®‰å…¨æ€§

**character_derived_stats è§†å›¾**:
- âœ… å·²æ”¹ä¸º `SECURITY INVOKER`
- âœ… è‡ªåŠ¨ç»§æ‰¿ `characters` è¡¨çš„ RLS ç­–ç•¥
- âœ… æ¶ˆé™¤æƒé™æå‡é£é™©

---

## ğŸ¯ ä¿®å¤åçš„å®‰å…¨ä¿éšœ

### æ•°æ®éš”ç¦»
- âœ… æ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- âœ… æ— æ³•æŸ¥çœ‹æˆ–ä¿®æ”¹å…¶ä»–ç©å®¶çš„è®°å½•
- âœ… é˜²æ­¢æ•°æ®æ³„éœ²

### ä½œå¼Šé˜²æŠ¤
- âœ… æ— æ³•ä¼ªé€  Boss å‡»è´¥è®°å½•
- âœ… æ— æ³•ç›´æ¥ä¿®æ”¹ä»»åŠ¡çŠ¶æ€
- âœ… æ— æ³•è·³è¿‡æ¸¸æˆé€»è¾‘

### æ¸¸æˆå…¬å¹³æ€§
- âœ… 24å°æ—¶åˆ·æ–°æœºåˆ¶å¾—åˆ°ä¿æŠ¤
- âœ… ä»»åŠ¡ç³»ç»Ÿå®Œæ•´æ€§å¾—åˆ°ä¿éšœ
- âœ… ç©å®¶è¿›åº¦çœŸå®å¯ä¿¡

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä½¿ç”¨çš„ Supabase MCP å·¥å…·

1. **mcp_supabase-mcp-server_execute_sql**  
   - ç”¨é€”: æŸ¥è¯¢è¡¨ç»“æ„å’ŒéªŒè¯ä¿®å¤ç»“æœ
   - è°ƒç”¨æ¬¡æ•°: 6 æ¬¡

2. **mcp_supabase-mcp-server_apply_migration**  
   - ç”¨é€”: æ‰§è¡Œæ•°æ®åº“è¿ç§»å’Œå®‰å…¨ç­–ç•¥åˆ›å»º
   - è°ƒç”¨æ¬¡æ•°: 2 æ¬¡
   - è¿ç§»åç§°:
     - `enable_rls_for_boss_defeats_and_player_quests`
     - `optimize_character_derived_stats_view_security`

### è¿ç§»æ–‡ä»¶ä½ç½®

Supabase å·²è‡ªåŠ¨è®°å½•è¿™äº›è¿ç§»,å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹:
```bash
# æŸ¥çœ‹è¿ç§»å†å²
supabase db migrations list --project-id xufhdurllimdmymuplox
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å¯¹ç°æœ‰ä»£ç çš„å½±å“

**å‡ ä¹æ— å½±å“**,å› ä¸º:
1. å‰ç«¯ä»£ç å·²ç»é€šè¿‡ Supabase å®¢æˆ·ç«¯è¿›è¡Œèº«ä»½éªŒè¯
2. RLS ç­–ç•¥ä¼šè‡ªåŠ¨ä½¿ç”¨ `auth.uid()` è·å–å½“å‰ç”¨æˆ·
3. æ‰€æœ‰åˆæ³•çš„æ•°æ®è®¿é—®éƒ½ä¼šæ­£å¸¸å·¥ä½œ

### å¯èƒ½éœ€è¦å¤„ç†çš„åœºæ™¯

å¦‚æœä»£ç ä¸­æœ‰ä»¥ä¸‹æƒ…å†µ,å¯èƒ½éœ€è¦è°ƒæ•´:

1. **åå°ç®¡ç†åŠŸèƒ½**:
   - å¦‚æœéœ€è¦ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰ç©å®¶æ•°æ®
   - éœ€è¦ä½¿ç”¨æœåŠ¡ç«¯å¯†é’¥(service_role key)è€Œä¸æ˜¯åŒ¿åå¯†é’¥

2. **æ•°æ®ç»Ÿè®¡åŠŸèƒ½**:
   - å¦‚æœéœ€è¦ç»Ÿè®¡æ‰€æœ‰ç©å®¶çš„ Boss å‡»è´¥æ¬¡æ•°
   - éœ€è¦åˆ›å»ºå•ç‹¬çš„è§†å›¾æˆ–ä½¿ç”¨ Edge Function

3. **æµ‹è¯•ç¯å¢ƒ**:
   - æµ‹è¯•æ—¶ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·èº«ä»½
   - å¯ä»¥ä¸´æ—¶ç¦ç”¨ RLS è¿›è¡Œæ•°æ®æ£€æŸ¥

---

## âœ… ä¿®å¤ç»“è®º

### å‘Šè­¦å¤„ç†çŠ¶æ€

| å‘Šè­¦ | çŠ¶æ€ | ä¿®å¤æ–¹å¼ |
|------|------|---------|
| #1 character_derived_stats | âœ… å·²è§£å†³ | æ”¹ä¸º SECURITY INVOKER |
| #2 boss_defeats | âœ… å·²è§£å†³ | å¯ç”¨ RLS + 3 ä¸ªç­–ç•¥ |
| #3 player_quests | âœ… å·²è§£å†³ | å¯ç”¨ RLS + 4 ä¸ªç­–ç•¥ |

### å®‰å…¨è¯„ä¼°

- **ä¿®å¤å‰**: ğŸš¨ é«˜é£é™© - å­˜åœ¨æ•°æ®æ³„éœ²å’Œä½œå¼Šæ¼æ´
- **ä¿®å¤å**: âœ… å®‰å…¨ - æ‰€æœ‰æ ¸å¿ƒè¡¨éƒ½å·²å— RLS ä¿æŠ¤

### å»ºè®®

1. âœ… **ç«‹å³éƒ¨ç½²**: è¿™äº›ä¿®å¤ä¸ä¼šå½±å“æ­£å¸¸åŠŸèƒ½,å»ºè®®ç«‹å³åº”ç”¨
2. âœ… **å®šæœŸæ£€æŸ¥**: å»ºè®®å®šæœŸè¿è¡Œ Supabase å®‰å…¨é¡¾é—®,æ£€æŸ¥æ–°çš„å‘Šè­¦
3. âœ… **å®Œå–„æµ‹è¯•**: åœ¨å¼€å‘ç¯å¢ƒéªŒè¯ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®å·¥ä½œ
4. âœ… **æ–‡æ¡£æ›´æ–°**: æ›´æ–°æ•°æ®åº“æ¶æ„æ–‡æ¡£,è¯´æ˜ RLS ç­–ç•¥

---

## ğŸ“š ç›¸å…³èµ„æº

- [Supabase RLS æ–‡æ¡£](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL Security Invoker Views](https://www.postgresql.org/docs/current/sql-createview.html)
- [Supabase å®‰å…¨æœ€ä½³å®è·µ](https://supabase.com/docs/guides/auth/security-best-practices)

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-01-21 13:58  
**æ€»è€—æ—¶**: çº¦ 5 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… æ‰€æœ‰å‘Šè­¦å·²æˆåŠŸä¿®å¤
